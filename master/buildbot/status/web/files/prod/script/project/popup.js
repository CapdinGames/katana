define(["jquery","helpers","libs/jquery.form","text!templates/popups.mustache","mustache","timeElements"],function(e,t,n,r,i,s){var o=e("body");(function(e){e.fn.popup=function(n){var r=e(this),i=e.extend({},e.fn.popup.defaults,n);r.settings=i;var s={init:function(){s.clear(),s.createHTML()&&(i.onCreate(r),i.autoShow&&r.ready(function(){s.showPopup()}))},createHTML:function(){return r.addClass("more-info-box more-info-box-js").append("<span class='close-btn'></span>").append(i.title).attr("data-ui-popup",!0),i.url?(e.ajax(i.url).done(function(e){r.append(e),i.onCreate(r),s.showPopup()}),!1):(r.append(e("<div/>").html(i.html)),!0)},clear:function(){r.attr("data-ui-popup")==="true"&&(i.destroyAfter?r.remove():r.empty())},showPopup:function(){i.center&&t.jCenter(r),i.animate?r.fadeIn(i.showAnimation,function(){s.initCloseButton(),i.onShow(r)}):r.show({complete:function(){i.onShow(r),s.initCloseButton()}})},hidePopup:function(){i.animate?r.fadeOut(i.hideAnimation,function(){s.clear()}):(r.hide(),s.clear())},initCloseButton:function(){e(document).bind("click touchstart",function(t){if(!r.is(t.target)&&r.has(t.target).length===0||r.find(".close-btn").is(t.target))s.hidePopup(),e(this).unbind(t)})}};return r.showPopup=function(){s.showPopup()},r.hidePopup=function(){s.hidePopup()},r.each(function(){s.init(),i.initalized=!0})},e.fn.popup.defaults={title:"<h3>Katana Popup</h3>",html:undefined,url:undefined,destroyAfter:!1,autoShow:!0,center:!0,animate:!0,showAnimation:"fast",hideAnimation:"fast",onCreate:function(){},onShow:function(){}}})(jQuery);var u;return u={init:function(){var t=e("#tablesorterRt");u.registerJSONPopup(t),e(".popup-btn-js-2").click(function(t){t.preventDefault(),u.nonAjaxPopup(e(this))}),e("#getBtn").click(function(e){e.preventDefault(),u.codebasesBranches()})},showjsonPopup:function(n){var s=i.render(r,n),o=e(i.render(r,{MoreInfoBoxOuter:!0},{partial:s}));e("body").append(o),n.showRunningBuilds!==undefined&&t.delegateToProgressBar(e("div.more-info-box-js div.percent-outer-js")),t.jCenter(o).fadeIn("fast",function(){t.closePopup(o)})},validateForm:function(t){var n=e(".command_forcebuild",t),s=":button, :hidden, :checkbox, :submit";e(".grey-btn",n).click(function(t){var o=e("input",n).not(s),u=o.filter(function(){return this.name.indexOf("revision")>=0}),a=u.filter(function(){return this.value===""});if(a.length>0&&a.length<u.length){u.each(function(){e(this).val()===""?e(this).addClass("not-valid"):e(this).removeClass("not-valid")}),e(".form-message",n).hide();if(!e(".error-input",n).length){var f=i.render(r,{errorinput:"true",text:"Fill out the empty revision fields or clear all before submitting"}),l=e(f);e(n).prepend(l)}t.preventDefault()}})},nonAjaxPopup:function(n){var r=n.next(e(".more-info-box-js")).clone();r.appendTo(e("body")),t.jCenter(r).fadeIn("fast",function(){t.closePopup(r)}),e(window).resize(function(){t.jCenter(r)})},codebasesBranches:function(){var n=e("#pathToCodeBases").attr("href"),s=i.render(r,{preloader:"true"}),o=e(s);e("body").append(o).show();var a=u.htmlModule("Select branches");e(a).appendTo("body"),e.get(n).done(function(n){requirejs(["selectors"],function(r){var i=e("#content1");o.remove();var s=e(n).find("#formWrapper");s.children("#getForm").attr("action",window.location.href);var u=s.find('.blue-btn[type="submit"]').val("Update");s.appendTo(i),t.jCenter(a).fadeIn("fast",function(){r.init(),u.focus(),t.closePopup(a)}),e(window).resize(function(){t.jCenter(a)})})})},customTabs:function(){e(".tabs-list li").click(function(t){var n=e(this).index();e(this).parent().find("li").removeClass("selected"),e(this).addClass("selected"),e(".content-blocks > div").each(function(t){e(this).index()!==n?e(this).hide():e(this).show()})})},htmlModule:function(t){var n=e('<div class="more-info-box remove-js"><span class="close-btn"></span><h3 class="codebases-head">'+t+"</h3>"+'<div id="content1"></div></div>');return n},registerJSONPopup:function(t){t.delegate("a.popup-btn-json-js","click",function(t){t.preventDefault(),u.showjsonPopup(e(this).data()),s.updateTimeObjects()})},initPendingPopup:function(n){function h(){var t=i.render(r,{preloader:"true"}),n=e(t);e("body").append(n).show(),e.ajax({url:c,cache:!1,dataType:"json",success:function(t){n.remove();var u=i.render(r,{pendingJobs:t,showPendingJobs:!0,cancelAllbuilderURL:t[0].builderURL});o.append(e("<div/>").popup({html:u,destroyAfter:!0,onCreate:function(n){var r=n.find(".waiting-time-js");r.each(function(n){s.addElapsedElem(e(this),t[n].submittedAt),s.updateTimeObjects()}),n.find("form").ajaxForm({success:function(e,t,r,i){requirejs(["realtimePages"],function(t){setTimeout(function(){var n="builders";t.updateSingleRealTimeData(n,e)},300)});var s=i.attr("id")==="cancelall";s||i.parent().remove(),(s||n.find("li").length===1)&&n.hidePopup()}})}}))}})}var u=e(n),a=encodeURIComponent(u.attr("data-builderName")),f=t.codebasesFromURL({}),l=t.urlParamsToString(f),c="/json/pending/{0}/?{1}".format(a,l);u.click(h)},initRunBuild:function(t,n){function f(t){var n=s.attr("data-builder-url"),a=s.attr("data-return-page"),f=s.attr("data-builder-name"),l=s.attr("data-popup-title"),c=location.protocol+"//"+location.host+"/forms/forceBuild",h={builder_url:n,builder_name:f,return_page:a},p=i.render(r,{preloader:"true"}),d=e(p);o.append(d),d.show(),e.get(c,h).done(function(n){d.hide();var r=e(n),i=e("<div/>").popup({title:e('<h2 class="small-head" />').html(l),html:n,destroyAfter:!0,autoShow:!1,onCreate:function(e){u.validateForm(e);var n=e.find("form"),r={beforeSubmit:function(){e.hidePopup(),d.show()},success:function(e){requirejs(["realtimePages"],function(t){var n=a.replace("_json","");t.updateSingleRealTimeData(n,e)}),d.remove()}};n.ajaxForm(r),t&&n.ajaxSubmit(r)}});o.append(i),t||i.showPopup()})}var s=e(t),a=e(n);if(s.length===0)return;s.click(function(){f(!1)}),a.click(function(){f(!0)})}},u});