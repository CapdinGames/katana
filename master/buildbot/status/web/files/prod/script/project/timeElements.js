define(["moment","extend-moment"],function(e,t){var n=5e3,r,i={timeAgo:[],elapsed:[],progressBars:[]},s,o=e.lang(),u=0,a={init:function(){s===undefined&&a._heartbeatInterval()},_heartbeatInterval:function(){clearTimeout(s),s=setTimeout(a._heartbeat,n)},_heartbeat:function(e){var t=new Date;if(e===!0||t-r>=n){var o=0;$.each(i.timeAgo,function(e,t){a.processTimeAgo(t.el,t.time),o++}),$.each(i.elapsed,function(e,t){a.processElapsed(t.el,t.time),o++}),$.each(i.progressBars,function(e,n){if(r!==undefined&&n.eta!=0){var i=t-r;n.eta-=i/1e3}a.processProgressBars(n.el,n.time,n.eta),o++}),r=t}u=o,s!==undefined&&a._heartbeatInterval()},_addElem:function(e,t,n){e.length&&$(e).attr("data-timeElem")===undefined&&($(e).attr("data-timeElem","true"),n.push(t))},addTimeAgoElem:function(e,t){var n=$(e),r={el:n,time:parseInt(t)};a._addElem(n,r,i.timeAgo)},addElapsedElem:function(e,t){var n=$(e),r={el:n,time:parseInt(t)};a._addElem(n,r,i.elapsed)},addProgressBarElem:function(e,t,n){var r=$(e),s={el:r,time:parseInt(t),eta:n};a._addElem(r,s,i.progressBars)},updateTimeObjects:function(){a._heartbeat(!0)},clearTimeObjects:function(e){if(e!==undefined){var t=$(e).find("[data-timeElem]");$.each(i,function(e,n){i[e]=$.grep(n,function(e){var n=!1;return $.contains(document.documentElement,e.el[0])?($.each(t,function(t,r){return $(r).is(e.el)?(n=!0,!1):!0}),n):!0},!0)})}else $.each(i,function(e){i[e]=[]})},processTimeAgo:function(t,n){t.html(e.unix(n).fromServerNow())},processElapsed:function(n,r){var i=t.getServerTime().unix(),s=i-r;e.lang("waiting-en"),n.html(e.duration(s,"seconds").humanize(!0)),e.lang(o)},processProgressBars:function(n,r,i){var s=t.getServerOffset(),u=e.unix(r),a=n.children(".percent-inner-js"),f=n.children(".time-txt-js"),l=i!=0,c=100;if(l){var h=e()+s,p=h+i*1e3,d=i<0,v=e().add("s",i)+s;c=100-(v-h)/(v-u)*100,c=c.clamp(0,100),e.lang("progress-bar-en"),f.html(e(p).fromServerNow()),d&&n.addClass("overtime")}else e.lang("progress-bar-no-eta-en"),f.html(e(parseInt(r*1e3)).fromServerNow());e.lang(o),a.css("width",c+"%")},setHeartbeat:function(e){n=e,a._heartbeatInterval()}};return a});