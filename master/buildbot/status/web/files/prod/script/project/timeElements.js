define(["jquery","moment","extend-moment"],function(e,t,n){var r=5e3,i=80,s,o={timeAgo:[],elapsed:[],progressBars:[]},u,a=t.lang(),f=0,l={heartbeatInterval:function(){clearTimeout(u),u=setTimeout(l.heartbeat,r)},heartbeat:function(t){var n=new Date;if(t===!0||n-s>r)e.each(o.timeAgo,function(e,t){l.processTimeAgo(t.el,t.time)}),e.each(o.elapsed,function(e,t){l.processElapsed(t.el,t.time)}),e.each(o.progressBars,function(e,t){if(s!==undefined&&t.eta!==0){var r=n-s;t.eta-=r/1e3}l.processProgressBars(t.el,t.time,t.eta)}),s=n;u!==undefined&&l.heartbeatInterval()},addElem:function(t,n,r){t.length&&e(t).attr("data-timeElem")===undefined&&(e(t).attr("data-timeElem","true"),r.push(n))},spinIconAnimation:function(){var t=10,n=13;e.each(e(".animate-spin"),function(r,i){var s=e(i);f>=t&&(f=0);var o=f*-n;s.css("background-position",o+"px 0px")}),f+=1},processTimeAgo:function(e,n){e.html(t.unix(n).fromServerNow())},processElapsed:function(e,r){var i=n.getServerTime().unix(),s=i-r;t.lang("waiting-en"),e.html(t.duration(s,"seconds").humanize(!0)),t.lang(a)},processProgressBars:function(e,r,i){var s=n.getServerOffset(),o=t.unix(r),u=e.children(".percent-inner-js"),f=e.children(".time-txt-js"),l=i!==0,c=100;if(l){var h=t()+s,p=h+i*1e3,d=i<0,v=t().add("s",i)+s;c=100-(v-h)/(v-o)*100,c=c.clamp(0,100),t.lang("progress-bar-en"),f.html(t(p).fromServerNow()),d&&e.addClass("overtime")}else t.lang("progress-bar-no-eta-en"),f.html(t(parseInt(r*1e3,10)).fromServerNow());t.lang(a),u.css("width",c+"%")}};return{init:function(){u===undefined&&l.heartbeatInterval(),setInterval(l.spinIconAnimation,i)},addTimeAgoElem:function(t,n){var r=e(t),i={el:r,time:parseInt(n,10)};l.addElem(r,i,o.timeAgo)},addElapsedElem:function(t,n){var r=e(t),i={el:r,time:parseInt(n,10)};l.addElem(r,i,o.elapsed)},addProgressBarElem:function(t,n,r){var i=e(t),s={el:i,time:parseInt(n,10),eta:parseInt(r,10)};l.addElem(i,s,o.progressBars)},updateTimeObjects:function(){l.heartbeat(!0)},clearTimeObjects:function(t){if(t!==undefined){var n=e(t).find("[data-timeElem]");e.each(o,function(t,r){o[t]=e.grep(r,function(t){var r=!1;return e.contains(document.documentElement,t.el[0])?(e.each(n,function(n,i){return e(i).is(t.el)?(r=!0,!1):!0}),r):!0},!0)})}else e.each(o,function(e){o[e]=[]})},setHeartbeat:function(e){r=e,l.heartbeatInterval()}}});