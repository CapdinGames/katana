define(["jquery","rtglobal","helpers"],function(e,t){var n=null,r={},i={},s="krtJSONData",o="krtURLDropped",u="krtRegisterURL",a=3e4,f=3e4,l={createWebSocket:function(t){return n==null&&("WebSocket"in window?n=new WebSocket(t):"MozWebSocket"in window?n=new MozWebSocket(t):(log("Browser does not support WebSocket!"),window.location="http://autobahn.ws/unsupportedbrowser"),n&&(n.onopen=function(){e("#bowlG").remove(),e.each(i,function(e,t){l.sendCommand(u,t)})},n.onclose=function(){n=null,console.log("We lost our connection, retrying in {0} seconds...".format(f/1e3)),setTimeout(function(){l.createWebSocket(t)},f)},n.onmessage=function(e){var t=e.data;typeof t=="string"&&(t=JSON.parse(t)),l.parseRealtimeCommand(t)})),n},initRealtime:function(t){r=t;var n=l.getInstantJSON();n!==undefined&&(console.log("Loaded from instant JSON"),l.updateRealTimeData(n,!0));var i=e("body").attr("data-realTimeServer");i!==undefined&&i!=""?(console.log(i),l.createWebSocket(i)):console.log("Realtime server not found, disabling realtime.")},sendCommand:function(e,t){if(n){var r=JSON.stringify({cmd:e,data:t});n.send(r)}},parseRealtimeCommand:function(e){e.cmd===s&&l.updateRealTimeData(e.data,!1),e.cmd===o&&(console.log("URL Dropped by server will retry in {0} seconds... ({1})".format(a/1e3,e.data)),setTimeout(function(){l.sendCommand(u,e.data)},a))},updateRealTimeData:function(t,n){if(n===!0)e.each(t,function(e,t){var n=t.data;typeof n=="string"&&(n=JSON.parse(n),i[e]=t.url),l.updateSingleRealTimeData(e,n)});else{var r=l.getRealtimeNameFromURL(t.url);l.updateSingleRealTimeData(r,t.data)}},getRealtimeNameFromURL:function(t){var n=undefined;return e.each(i,function(e,r){return r===t?(n=e,!1):!0}),n},updateSingleRealTimeData:function(e,t){r.hasOwnProperty(e)&&(r[e](t),console.log("Reloading data for {0}...".format(e)))},getInstantJSON:function(){var t=e("#instant-json");return e("#bowlG").remove(),t.length?(t.remove(),instantJSON):undefined},defaultRealtimeFunctions:function(){return{global:t.processGlobalInfo}}};return l});