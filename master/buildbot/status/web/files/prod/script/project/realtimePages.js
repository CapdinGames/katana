define(["jquery","rtglobal","helpers"],function(e,t){var n=null,r={},i={},s={},o="krtJSONData",u="krtURLDropped",a="krtRegisterURL",f=3e4,l=3e4,c=5e3,h={createWebSocket:function(t){return n==null&&("WebSocket"in window?n=new WebSocket(t):"MozWebSocket"in window?n=new MozWebSocket(t):(log("Browser does not support WebSocket!"),window.location="http://autobahn.ws/unsupportedbrowser"),n&&(n.onopen=function(){e("#bowlG").remove(),e.each(i,function(e,t){h.sendCommand(a,t)})},n.onclose=function(){n=null,console.log("We lost our connection, retrying in {0} seconds...".format(l/1e3)),setTimeout(function(){h.createWebSocket(t)},l)},n.onmessage=function(e){var t=e.data;typeof t=="string"&&(t=JSON.parse(t)),h.parseRealtimeCommand(t)})),n},initRealtime:function(t){r=t;var n=h.getInstantJSON();n!==undefined&&(console.log("Loaded from instant JSON"),h.updateRealTimeData(n,!0));var i=e("body").attr("data-realTimeServer");i!==undefined&&i!=""?(console.log(i),h.createWebSocket(i)):console.log("Realtime server not found, disabling realtime.")},sendCommand:function(e,t){if(n){var r=JSON.stringify({cmd:e,data:t});n.send(r)}},parseRealtimeCommand:function(e){e.cmd===o&&h.updateRealTimeData(e.data,!1),e.cmd===u&&(console.log("URL Dropped by server will retry in {0} seconds... ({1})".format(f/1e3,e.data)),setTimeout(function(){h.sendCommand(a,e.data)},f))},updateRealTimeData:function(t,n){if(n===!0)e.each(t,function(e,t){var n=t.data;typeof n=="string"&&(n=JSON.parse(n),i[e]=t.url),h.updateSingleRealTimeData(e,n)});else{var r=h.getRealtimeNameFromURL(t.url);h.updateSingleRealTimeData(r,t.data)}},getRealtimeNameFromURL:function(t){var n=undefined;return e.each(i,function(e,r){return r===t?(n=e,!1):!0}),n},updateSingleRealTimeData:function(e,t,n){var i=!0,o=new Date;(n==undefined||!n)&&s.hasOwnProperty(e)&&o-s[e]<c&&(i=!1),i&&r.hasOwnProperty(e)&&(r[e](t),s[e]=o,console.log("Reloading data for {0}...".format(e)))},getInstantJSON:function(){var t=e("#instant-json");return e("#bowlG").remove(),e("#tablesorterRt, .initjson").show(),t.length?(t.remove(),instantJSON):undefined},defaultRealtimeFunctions:function(){return{global:t.processGlobalInfo}}};return h});