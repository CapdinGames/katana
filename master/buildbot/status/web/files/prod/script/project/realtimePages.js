define(["jquery","rtglobal","helpers","timeElements"],function(e,t){var o=null,n={},a={},i={},r="krtJSONData",l="krtURLDropped",s="krtRegisterURL",d=3e4,u=3e4,c=500,m={createWebSocket:function(t,n){if(null===o){if(void 0!==window.WebSocket)o=new window.WebSocket(t);else{if(void 0===window.MozWebSocket)return void console.log("Realtime is not supported on this browser.");o=new window.MozWebSocket(t)}o&&(o.onopen=function(){e("#bowlG").remove(),e.each(a,function(e,t){var o={url:t};void 0!==n&&(o.waitForPush=n[e].waitForPush,o.pushFilters=n[e].pushFilters),m.sendCommand(s,o)})},o.onclose=function(){o=null,console.log("We lost our connection, retrying in {0} seconds...".format(u/1e3)),setTimeout(function(){m.createWebSocket(t,n)},u)},o.onmessage=function(e){var t=e.data;"string"==typeof t&&(t=JSON.parse(t)),m.parseRealtimeCommand(t)})}return o},initRealtime:function(t){n=t;var a=m.getInstantJSON();void 0!==a&&(console.log("Loaded from instant JSON"),m.updateRealTimeData(a,!0));var i=e("body").attr("data-realTimeServer");return void 0!==i&&""!==i?(console.log(i),m.createWebSocket(i,a),o):void console.log("Realtime server not found, disabling realtime.")},sendCommand:function(e,t){if(o){var n=JSON.stringify({cmd:e,data:t});o.send(n)}},parseRealtimeCommand:function(e){e.cmd===r&&m.updateRealTimeData(e.data,!1),e.cmd===l&&(console.log("URL Dropped by server will retry in {0} seconds... ({1})".format(d/1e3,e.data)),setTimeout(function(){m.sendCommand(s,e.data)},d))},updateRealTimeData:function(t,o){if(o===!0)e.each(t,function(e,t){var o=t.data;"string"==typeof o&&(o=JSON.parse(o),a[e]=t.url),m.updateSingleRealTimeData(e,o)});else{var n=m.getRealtimeNameFromURL(t.url);m.updateSingleRealTimeData(n,t.data)}},getRealtimeNameFromURL:function(t){var o;return e.each(a,function(e,n){return n===t?(o=e,!1):!0}),o},updateSingleRealTimeData:function(e,t,o){var a=!0,r=new Date;void 0!==o&&o||!i.hasOwnProperty(e)||r-i[e]<c&&(a=!1),a&&n.hasOwnProperty(e)&&(n[e](t),i[e]=r,console.log("Reloading data for {0}...".format(e)))},getInstantJSON:function(){var t=e("#instant-json");return e("#bowlG").remove(),e(".initjson").show(),t.length&&void 0!==window.instantJSON?(t.remove(),window.instantJSON):void 0},defaultRealtimeFunctions:function(){return{global:t.processGlobalInfo}},setReloadCooldown:function(e){c=e}};return m});
//# sourceMappingURL=realtimePages.js.map