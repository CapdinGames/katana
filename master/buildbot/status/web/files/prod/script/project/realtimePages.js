define(["jquery","helpers"],function(e,t){var n,r=null,i=null,s="krtJSONData",o="krtURLDropped",u="krtRegisterURL";return n={createWebSocket:function(i){return r==null&&("WebSocket"in window?r=new WebSocket(i):"MozWebSocket"in window?r=new MozWebSocket(i):(log("Browser does not support WebSocket!"),window.location="http://autobahn.ws/unsupportedbrowser"),r&&(r.onopen=function(){e("#bowlG").remove(),n.sendCommand(u,t.getJsonUrl())},r.onclose=function(e){r=null,console.log("We lost our connection, retrying in 5 seconds..."),setTimeout(function(){n.createWebSocket(i)},5e3)},r.onmessage=function(e){var t=e.data;typeof t=="string"&&(t=JSON.parse(t)),n.parseRealtimeCommand(t)})),r},initRealtime:function(t){i=t;var r=n.getInstantJSON();r!==undefined&&(console.log("Loaded from instant JSON"),n.updateRealTimeData(r));var s=e("body").attr("data-realTimeServer");s!==undefined&&s!=""?(console.log(s),n.createWebSocket(s)):console.log("Realtime server not found, disabling realtime.")},sendCommand:function(e,t){if(r){var n=JSON.stringify({cmd:e,data:t});r.send(n)}},parseRealtimeCommand:function(e){e.cmd===s&&n.updateRealTimeData(e.data.data),e.cmd===o&&(console.log("URL Dropped by server will retry in 5 seconds..."),setTimeout(function(){n.sendCommand(u,t.getJsonUrl())},5e3))},updateRealTimeData:function(e){i(e),console.log("Reloading data...")},getInstantJSON:function(){var t=e("#instant-json");return t.length?(t.remove(),instantJSON):undefined}},n});