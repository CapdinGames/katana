define(["jquery","rtglobal","helpers","timeElements"],function(e,n){var o=null,t={},a={},i={},r="krtJSONData",l="krtURLDropped",d="krtRegisterURL",s=3e4,c=3e4,u=5e3,m={createWebSocket:function(n){if(null===o){if(void 0!==window.WebSocket)o=new window.WebSocket(n);else{if(void 0===window.MozWebSocket)return void console.log("Realtime is not supported on this browser.");o=new window.MozWebSocket(n)}o&&(o.onopen=function(){e("#bowlG").remove(),e.each(a,function(e,n){m.sendCommand(d,n)})},o.onclose=function(){o=null,console.log("We lost our connection, retrying in {0} seconds...".format(c/1e3)),setTimeout(function(){m.createWebSocket(n)},c)},o.onmessage=function(e){var n=e.data;"string"==typeof n&&(n=JSON.parse(n)),m.parseRealtimeCommand(n)})}return o},initRealtime:function(n){t=n;var a=m.getInstantJSON();void 0!==a&&(console.log("Loaded from instant JSON"),m.updateRealTimeData(a,!0));var i=e("body").attr("data-realTimeServer");return void 0!==i&&""!==i?(console.log(i),m.createWebSocket(i),o):void console.log("Realtime server not found, disabling realtime.")},sendCommand:function(e,n){if(o){var t=JSON.stringify({cmd:e,data:n});o.send(t)}},parseRealtimeCommand:function(e){e.cmd===r&&m.updateRealTimeData(e.data,!1),e.cmd===l&&(console.log("URL Dropped by server will retry in {0} seconds... ({1})".format(s/1e3,e.data)),setTimeout(function(){m.sendCommand(d,e.data)},s))},updateRealTimeData:function(n,o){if(o===!0)e.each(n,function(e,n){var o=n.data;"string"==typeof o&&(o=JSON.parse(o),a[e]=n.url),m.updateSingleRealTimeData(e,o)});else{var t=m.getRealtimeNameFromURL(n.url);m.updateSingleRealTimeData(t,n.data)}},getRealtimeNameFromURL:function(n){var o;return e.each(a,function(e,t){return t===n?(o=e,!1):!0}),o},updateSingleRealTimeData:function(e,n,o){var a=!0,r=new Date;void 0!==o&&o||!i.hasOwnProperty(e)||r-i[e]<u&&(a=!1),a&&t.hasOwnProperty(e)&&(t[e](n),i[e]=r,console.log("Reloading data for {0}...".format(e)))},getInstantJSON:function(){var n=e("#instant-json");return e("#bowlG").remove(),e(".initjson").show(),n.length&&void 0!==window.instantJSON?(n.remove(),window.instantJSON):void 0},defaultRealtimeFunctions:function(){return{global:n.processGlobalInfo}},setReloadCooldown:function(e){u=e}};return m});
//# sourceMappingURL=realtimePages.js.map