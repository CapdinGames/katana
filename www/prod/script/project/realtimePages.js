define(["jquery","rtGlobal","helpers","timeElements"],function(e,o){var t=null,n={},a={},r={},i="krtJSONData",l="krtURLDropped",d="krtRegisterURL",s=3e4,u=3e4,c=500,m={createWebSocket:function(o,n){if(null===t){if(void 0!==window.WebSocket)t=new window.WebSocket(o);else{if(void 0===window.MozWebSocket)return void console.log("Realtime is not supported on this browser.");t=new window.MozWebSocket(o)}t&&(t.onopen=function(){e("#preloader").preloader("hidePreloader"),e.each(a,function(e,o){var t={url:o};void 0!==n&&(t.waitForPush=n[e].waitForPush,t.pushFilters=n[e].pushFilters),m.sendCommand(d,t)})},t.onclose=function(){t=null,console.log("We lost our connection, retrying in {0} seconds...".format(u/1e3)),setTimeout(function(){m.createWebSocket(o,n)},u)},t.onmessage=function(e){var o=e.data;"string"==typeof o&&(o=JSON.parse(o)),m.parseRealtimeCommand(o)})}return t},initRealtime:function(o){n=o;var a=m.getInstantJSON();void 0!==a&&(console.log("Loaded from instant JSON"),m.updateRealTimeData(a,!0));var r=e("body").attr("data-realTimeServer");return void 0!==r&&""!==r?(console.log(r),m.createWebSocket(r,a),t):void console.log("Realtime server not found, disabling realtime.")},sendCommand:function(e,o){if(t){var n=JSON.stringify({cmd:e,data:o});t.send(n)}},parseRealtimeCommand:function(e){e.cmd===i&&m.updateRealTimeData(e.data,!1),e.cmd===l&&(console.log("URL Dropped by server will retry in {0} seconds... ({1})".format(s/1e3,e.data)),setTimeout(function(){m.sendCommand(d,e.data)},s))},updateRealTimeData:function(o,t){if(t===!0)e.each(o,function(e,o){var t=o.data;"string"==typeof t&&(t=JSON.parse(t),a[e]=o.url),m.updateSingleRealTimeData(e,t)});else{var n=m.getRealtimeNameFromURL(o.url);m.updateSingleRealTimeData(n,o.data)}},getRealtimeNameFromURL:function(o){var t;return e.each(a,function(e,n){return n===o?(t=e,!1):!0}),t},updateSingleRealTimeData:function(e,o,t){var a=!0,i=new Date;void 0!==t&&t||!r.hasOwnProperty(e)||i-r[e]<c&&(a=!1),a&&n.hasOwnProperty(e)&&(n[e](o),r[e]=i,console.log("Reloading data for {0}...".format(e)))},getInstantJSON:function(){var o=e("#instant-json");return e("#preloader").preloader("hidePreloader"),e(".initjson").show(),o.length&&void 0!==window.instantJSON?(o.remove(),window.instantJSON):void 0},defaultRealtimeFunctions:function(){return{global:o.processGlobalInfo}},setReloadCooldown:function(e){c=e}};return m});
//# sourceMappingURL=realtimePages.js.map